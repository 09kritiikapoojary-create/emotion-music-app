<!DOCTYPE html>
<html>
<head>
  <title>Emotion Music Recommendation</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body>

<a href="/logout" class="logout-btn">Logout</a>

<h1 align="center">Mood Music Recommender</h1>

<div class="main-container">

  <div class="left-panel">
    <h2>Emotion Detector</h2>
    <div class="outer-shadow">
      <video id="video" width="100%" autoplay></video>
      <canvas id="canvas" style="display:none;"></canvas>
    </div>
  </div>

  <div class="right-panel">
    <h2>Song Recommendations</h2>
    <div class="outer-shadow" id="ResultArea"></div>
  </div>

</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script>

const video = document.getElementById('video');

// Open browser camera
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => {
    video.srcObject = stream;
  });

async function detectAndUpdate() {

  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  context.drawImage(video, 0, 0);

  const imageData = canvas.toDataURL('image/jpeg');

  try {

    // 1️⃣ Detect emotion
    const emotionResponse = await fetch('/detect_emotion', {
      method: 'POST',
      body: JSON.stringify({ image: imageData }),
      headers: { 'Content-Type': 'application/json' }
    });

    const emotionData = await emotionResponse.json();
    console.log("Detected:", emotionData.emotion);

    // 2️⃣ Immediately load songs AFTER emotion update
    const songsResponse = await fetch('/t');
    const songs = await songsResponse.json();

    $("#ResultArea").html("");

    var table = $("<table class='table table-striped table-light table-bordered table-hover table-sm'></table>").appendTo("#ResultArea");

    var rowHeader = $("<tr></tr>").appendTo(table);
    $("<td>Name</td>").appendTo(rowHeader);
    $("<td>Album</td>").appendTo(rowHeader);
    $("<td>Artist</td>").appendTo(rowHeader);

    $.each(songs, function (i, value) {
      var row = $("<tr></tr>").appendTo(table);
      $("<td></td>").text(value.Name).appendTo(row);
      $("<td></td>").text(value.Album).appendTo(row);
      $("<td></td>").text(value.Artist).appendTo(row);
    });

  } catch (error) {
    console.log("Error:", error);
  }
}

// Run every 3 seconds (more stable)
setInterval(detectAndUpdate, 3000);

</script>

</body>
</html>


