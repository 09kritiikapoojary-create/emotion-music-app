<!DOCTYPE html>
<html>
<head>
  <title>Emotion Music Recommendation</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body>

<a href="/logout" class="logout-btn">Logout</a>

<h1 align="center">Mood Music Recommender</h1>

<div class="main-container">

  <div class="left-panel">
    <h2>Emotion Detector</h2>
    <div class="outer-shadow">
      <video id="video" width="100%" autoplay></video>
      <canvas id="canvas" style="display:none;"></canvas>
    </div>
  </div>

  <div class="right-panel">
    <h2>Song Recommendations</h2>
    <div class="outer-shadow" id="ResultArea"></div>
  </div>

</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script>

const video = document.getElementById('video');

// Open browser camera
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => {
    video.srcObject = stream;
  });

// ðŸ”¥ AUTO EMOTION DETECTION FUNCTION
function detectEmotionAuto() {

  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  context.drawImage(video, 0, 0);

  const imageData = canvas.toDataURL('image/jpeg');

  fetch('/detect_emotion', {
    method: 'POST',
    body: JSON.stringify({ image: imageData }),
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
      console.log("Detected:", data.emotion);
  });
}

// ðŸ”¥ Run emotion detection every 2 seconds
setInterval(detectEmotionAuto, 2000);

// ðŸ”¥ Update table every 2 seconds
setInterval(function () {

  $.getJSON('/t', function (data) {

    $("#ResultArea").html("");

    var table = $("<table class='table table-striped table-light table-bordered table-hover table-sm'></table>").appendTo("#ResultArea");

    var rowHeader = $("<tr></tr>").appendTo(table);
    $("<td>Name</td>").appendTo(rowHeader);
    $("<td>Album</td>").appendTo(rowHeader);
    $("<td>Artist</td>").appendTo(rowHeader);

    $.each(data, function (i, value) {
      var row = $("<tr></tr>").appendTo(table);
      $("<td></td>").text(value.Name).appendTo(row);
      $("<td></td>").text(value.Album).appendTo(row);
      $("<td></td>").text(value.Artist).appendTo(row);
    });

  });

}, 2000);

</script>

</body>
</html>


